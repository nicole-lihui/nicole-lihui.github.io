# 密码加密

## 背景与分析

> 保护密码最好的的方式就是使用带盐的密码 hash(salted password hashing).对密码进行 hash 操作是一件很简单的事情

hash 的账号系统中，用户注册和认证的大致流程如下：

1. 用户创建账号。
2. 用户密码 hash 后存储。（生产环境不会采用明文存储密码）。
3. 用户登录时，将用户的密码进行 hash 操作后，与数据库中 hash 后的密码进行比较。
4. 如果 hash 值完全一样，则认为密码一致；否则提示用户 ”用户名或密码不正确“。
   > 不要告诉用户是账号还是密码错了。只需要显示一个通用的提示，比如账号或密码不正确就可以了。这样可以防止攻击者枚举有效的用户名
5. 用户登录时，重复 3、4 步骤。

## 如何破解 hash

1. 字典和暴力破解攻击(Dictionary and Brute Force Attacks)
2. 查表破解(Lookup Tables)
3. 反向查表破解(Reverse Lookup Tables)
4. 彩虹表 (Rainbow Tables)

## 加盐 Hash 密码加密（ salted password hashing ）

> 查表和彩虹表的方式之所以有效是因为每一个密码的都是通过同样的方式来进行 hash 的。如果两个用户使用了同样的密码，那么一定他们的密码 hash 也一定相同。我们可以通过让每一个 hash 随机化，同一个密码 hash 两次，得到的不同的 hash 来避免这种攻击。

> 具体的操作就是给密码加一个随即的前缀或者后缀，然后再进行 hash。这个随即的后缀或者前缀成为“盐”。正如上面给出的例子一样，通过加盐，相同的密码每次 hash 都是完全不一样的字符串了。检查用户输入的密码是否正确的时候，我们也还需要这个盐，所以盐一般都是跟 hash 一起保存在数据库里，或者作为 hash 字符串的一部分。

> 盐不需要保密，只要盐是随机的话，查表，彩虹表都会失效。因为攻击者无法事先知道盐是什么，也就没有办法预先计算出查询表和彩虹表。如果每个用户都是使用了不同的盐，那么反向查表攻击也没法成功。

### 盐的常见的错误实现。

1. 盐的复用(Salt Reuse)
   - 不管是将盐硬编码在程序里还是随机一次生成的，在每一个密码 hash 里使用相同的盐会使这种防御方法失效。因为相同的密码 hash 两次得到的结果还是相同的。攻击者就可以使用反向查表的方式进行字典和暴力攻击。只要在对字典中每一个密码进行 hash 之前加上这个固定的盐就可以了。如果是流行的程序的使用了硬编码的盐，那么也可能出现针对这种程序的这个盐的查询表和彩虹表，从而实现快速破解 hash。
   - **用户每次创建或者修改密码一定要使用一个新的随机的盐**
2. 短的盐
   - 如果盐的位数太短的话，攻击者也可以预先制作针对所有可能的盐的查询表。比如，3 位 ASCII 字符的盐，一共有 95x95x95 = 857,375 种可能性。看起来好像很多。假如每一个盐制作一个 1MB 的包含常见密码的查询表，857,375 个盐才是 837GB。现在买个 1TB 的硬盘都只要几百块而已。
   - 基于同样的理由，千万不要用用户名做为盐。虽然对于每一个用户来说用户名可能是不同的，但是用户名是可预测的，并不是完全随机的。攻击者完全可以用常见的用户名作为盐来制作查询表和彩虹表破解 hash
   - 根据一些经验得出来的规则就是盐的大小要跟 hash 函数的输出一致。比如，SHA256 的输出是 256bits(32bytes),盐的长度也应该是 32 个字节的随机数据
3. 双重 hash 和古怪的 hash 函数
   - 古怪的 hash 算法组合。人们可能解决的将不同的 hash 函数组合在一起用可以让数据更安全。但实际上，这种方式带来的效果很微小。反而可能带来一些互通性的问题，甚至有时候会让 hash 更加的不安全。
   - **永远不要尝试自己写 hash 算法，要使用专家们设计的标准算法**。
   - 有些人会觉得通过使用多个 hash 函数可以降低计算 hash 的速度，从而增加破解的难度。通过减慢 hash 计算速度来防御攻击有更好的方法:慢速 hash 函数

## hash 碰撞(Hash Collisions)

因为 hash 函数是将任意数量的数据映射成一个固定长度的字符串，所以一定存在不同的输入经过 hash 之后变成相同的字符串的情况。加密 hash 函数(Cryptographic hash function)在设计的时候希望使这种碰撞攻击实现起来成本难以置信的高。但时不时的就有密码学家发现快速实现 hash 碰撞的方法。最近的一个例子就是 MD5，它的碰撞攻击已经实现了。

碰撞攻击是找到另外一个跟原密码不一样，但是具有相同 hash 的字符串。但是，即使在相对弱的 hash 算法，比如 MD5,要实现碰撞攻击也需要大量的算力(computing power),所以在实际使用中偶然出现 hash 碰撞的情况几乎不太可能。一个使用加盐 MD5 的密码 hash 在实际使用中跟使用其他算法比如 SHA256 一样安全。不过如果可以的话，使用更安全的 hash 函数，比如 SHA256, SHA512, RipeMD, WHIRLPOOL 等是更好的选择。

## 如何恰当的进行 hash

### 加盐 Hash

我们已经知道恶意黑客可以通过查表和彩虹表的方式快速的获得 hash 对应的明文密码，我们也知道了通过使用随机的盐可以解决这个问题。但是我们怎么生成盐，怎么在 hash 的过程中使用盐呢？

盐要使用密码学上可靠安全的伪随机数生成器(Cryptographically Secure Pseudo-Random Number Generator (CSPRNG))来产生。CSPRNG 跟普通的伪随机数生成器比如 C 语言中的 rand(),有很大不同。正如它的名字说明的那样，CSPRNG 提供一个高标准的随机数，是完全无法预测的。我们不希望我们的盐能够被预测到，所以一定要使用 CSPRNG。

### 密码存储与校验流程

- 密码存储

  - 使用 CSPRNG 生成一个长的随机盐
  - 将密码与盐拼接，使用标准的 hash 如 sha256 进行 hash
  - 将盐和 hash 存储在数据库中

- 密码验证
  - 从数据库中取出盐与密码
  - 密码、盐用相同的方式平均，进行 hash
  - 比较当前 hash 与存储 hash 是否一致，相同则密码正确，不同则密码错误

## 参考

[加盐 hash 保存密码的正确方式](https://blog.csdn.net/z1848w/article/details/48494055)
[加盐密码保存的最通用方法是？](https://www.zhihu.com/question/20299384)
