# Basic

1. 传统page查询和cursor查询的区别
2. 保证id全局唯一， 雪花算法

## 基础知识点

## 实践
### 传统page查询和cursor查询的区别
#### 传统page查询（limit, offset）
##### 设计：
  > 通常在分页时会携带两个可选参数，limit和offset, SQL语句如下
```sql
mysql> SELECT * FROM TEST_TABLE LIMIT offset, limit;
-- Or
mysql> SELECT * FROM TEST_TABLE LIMIT limit, OFFSET offset;
```
##### 问题：
1. 当数据库数据越大，性能消耗越大（全表深度查询）
   * 例如数据库集群，5台服务器，需要查询5000条数据，数据库需要在每台服务器中查询前5000条，总共获取25000条数据，然后重新排序获取5000条。当数据库数据越庞大，性能消耗就越大。
2. 数据重复 
```bash
+---------------------------+
| 1 | 2 | 3 | 4 | 5 | 6 | 7 |
+---------------------------+
        || 参数：limit=3&offset=0，得到      
    +-----------+
    | 1 | 2 | 3 |
    +-----------+

        || 删除一条数据（2）

+-----------------------+
| 1 | 3 | 4 | 5 | 6 | 7 |
+-----------------------+

       || 参数：limit=3&offset=3, 得到
    +-----------+
    | 5 | 6 | 7 |
    +-----------+

期望：4，5，6
实际：5，6，7，这就导致4这条记录没有被取到
```
3. 数据丢失
```bash
+---------------------------+
| 1 | 2 | 3 | 4 | 5 | 6 | 7 |
+---------------------------+
        || 参数：limit=3&offset=0，得到      
    +-----------+
    | 1 | 2 | 3 |
    +-----------+

        || 插入一条数据

+-------------------------------+
| 1 | 8 | 2 | 3 | 4 | 5 | 6 | 7 |
+-------------------------------+

       || 参数：limit=3&offset=3, 得到
    +-----------+
    | 3 | 4 | 5 |
    +-----------+

期望：4，5，6，
实际：3，4，5，与第一次取出的1，2，3 重复了 3 这条数据
```

#### cursor查询
##### 设计
* 基于游标的分页，需要有一个惟一的序列字段 (或多个)，比如惟一的整数 ID 或时间戳
* 
  > 游标分页是通过 cursor 和 size 这样的类似两个参数来控制翻页，简单的 SQL 语句如下：
```sql
mysql> select * from data where id>cursor limit size
```
这样再来看上面的两个问题，第一个参数变为 cursor=3&size=3，结果为 4，5，6，符合预期
第二个参数取出结果为 4，5，6，也符合预期。看来数据缺失和数据重复的问题得到了解决 
##### 问题

#### 总结
* >如果我们的表没有主键，比如是具有多对多关系的表，那么就使用传统的 page查询方式，只是这样做存在潜在的慢查询问题。我建议在需要分页的表中使用自动递增的主键，即使只是为了分页。
* >如果数据庞大，拥有唯一的键，选择cursor查询
* >对于普通的应用，尤其是数据量在百万级别以下的应用，其实 MySQL 通用的分页方式性能足够，而且足够简单并且方便使用，不必过早优化。只要做好最大分页数量和分页每页的数量限制，MySQL 的缓存适当针对机器的性能和应用的实际需求调优一下，通用的分页方式性能足够。我想，多数的应用，其实都是到不了百万级别的数据量吧
* >不过考虑到编程实现的方便程度，其实最后的流式分页/游标分页的方式，编程实现是最简单的，并且性能根本无须考虑，哪怕你有亿级的数据。并且流式分页/游标分页非常适合在 API 中分页输出，在手机信息流中这种无线滚动的信息流中进行分页输出，不会丢也不会重复输出某个条目，优势非常明显，堪称最佳的分页方式。不过话说回来，缺点也很明显，就是不能像普通分页那样有第一页第二页到第N页的数字页码，简单说就是没有页数的概念了，前端页面输出一般只有上一页和下一页这样简单的翻页按钮
* >需要提醒的是，所有的分页查询条件都必须建立索引，并且不能有 TEXT 字段。MySQL 的索引字段中，VARCHAR(32) 我都觉得很大了， TEXT 字段简直是不能容忍的，不怕死的可以自己试试。

#### 参考
[MySQL 游标分页与传统分页](https://github.com/x1ah/Blog/issues/15)
[MySQL 数据库中的分页方案及其效率对比](https://www.mywaiting.com/weblogs/pagination-with-mysql/)